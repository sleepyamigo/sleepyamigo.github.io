<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      background: linear-gradient(135deg, #e0eafc 0%, #f8fafc 100%);
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', 'Arial', sans-serif;
      transition: background 0.5s;
    }

    #user-info-message {
      color: #22223b;
      background: #f2e9e4;
      border-radius: 18px;
      padding: 36px 48px;
      box-shadow: 0 8px 32px rgba(34, 34, 59, 0.10);
      font-size: 1.25rem;
      max-width: 85vw;
      margin: 0 auto;
      letter-spacing: 0.01em;
      line-height: 1.6;
      border: none;
      font-weight: 500;
      transition: box-shadow 0.3s, background 0.3s;
    }

    #user-info-message:hover {
      box-shadow: 0 12px 36px rgba(34, 34, 59, 0.15);
      background: #e9ecef;
    }
  </style>
  <script>
    let openedPopup; // Stores the reference to the opened window

    // Parses a query string parameter from the URL
    function getUrlParameter(paramKey) {
      const searchParams = new URLSearchParams(window.location.search);
      if (searchParams.has(paramKey)) {
        return searchParams.get(paramKey);
      }
      // If the parameter is not found, redirect to your main page
      window.location.href = "https://sleepyamigo.github.io/";
      return null; // This line won't be reached if redirection occurs
    }
    // Function to get an optional query parameter, with a default value
    function getOptionalUrlParameter(paramKey, defaultValue) {
      const searchParams = new URLSearchParams(window.location.search);
      if (searchParams.has(paramKey)) {
        return searchParams.get(paramKey);
      }
      return defaultValue;
    }

    // Function to redirect the opened popup after a delay
    function performDelayedRedirect() {
      // Use 'redirect_target' query param, or default to your main page
      const redirectUrl = getOptionalUrlParameter("redirect_target", "https://sleepyamigo.github.io/");
      console.log("[Popup] Scheduled redirect to:", redirectUrl);
      if (openedPopup && !openedPopup.closed) {
        try {
          console.log("[Popup] Attempting to set location to:", redirectUrl);
          openedPopup.location = redirectUrl;
          console.log("[Popup] Redirect command issued.");
        } catch (e) {
          console.error("[Popup] Error redirecting popup. It might be a cross-origin issue if the initial target was different.", e);
        }
      } else {
        console.log("[Popup] Popup window was not found or has been closed by the user.");
      }
    }

    // Opens the target URL in a new window and schedules the redirect
    function openTargetInNewWindow() {
      const targetUrl = getUrlParameter("target");
      console.log("[Main] openTargetInNewWindow called. targetUrl:", targetUrl);
      // If getUrlParameter caused a redirect (param missing), this part won't run on the original page
      if (targetUrl) {
        openedPopup = window.open(targetUrl, "targetPopupWindow", "noopener,noreferrer"); // "targetPopupWindow" is the window name
        if (openedPopup) {
          console.log("[Main] Target URL successfully opened in a new window:", targetUrl);
          setTimeout(performDelayedRedirect, 5000); // 5-second delay
        } else {
          console.warn("[Main] Popup window was blocked or failed to open.");
          // Optionally, update the message to inform the user the popup was blocked.
          const msgElement = document.getElementById('user-info-message');
          if (msgElement) {
            msgElement.innerText += " (It seems the popup was blocked. Please enable popups for this site and click again.)";
          }
        }
      }
    }

    // Sets up the page functionality on load
    function initializePage() {
      console.log("[Main] initializePage called.");
      // Get the target URL for the message. 
      // If "target" is missing, getUrlParameter will redirect the current page.
      const targetUrlForDisplay = getUrlParameter("target");
      console.log("[Main] targetUrlForDisplay:", targetUrlForDisplay);
      // Add click listener to the body to re-attempt opening the window
      document.body.addEventListener('click', function () {
        console.log("[Main] Body clicked. Attempting to open popup again.");
        openTargetInNewWindow();
      });
      const messageElement = document.createElement('div');
      messageElement.id = 'user-info-message'; // New ID for the message element
      // Updated user-facing message
      messageElement.innerText = `The requested content should open in a new window shortly. If it doesn't appear, or if you close it, please click anywhere on this page to try opening ${decodeURIComponent(targetUrlForDisplay || '')} again.`;
      // Clear previous message if any, then add new one
      const existingMessage = document.getElementById('user-info-message'); // Check for new ID
      if (existingMessage) {
        existingMessage.remove();
      } else { // If using the old ID, check for that too
        const oldMessage = document.getElementById('message');
        if (oldMessage) {
          oldMessage.remove();
        }
      }
      document.body.appendChild(messageElement);
      // Attempt to open the window automatically
      openTargetInNewWindow();
    }

    window.onload = initializePage;
  </script>
</head>

<body></body>

</html>